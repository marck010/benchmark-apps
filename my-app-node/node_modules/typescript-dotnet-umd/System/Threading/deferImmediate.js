/*!
 * @author electricessence / https://github.com/electricessence/
 * Licensing: MIT https://github.com/electricessence/TypeScript.NET/blob/master/LICENSE.md
 * Based on code from: https://github.com/kriskowal/q
 */
!function(e){if("object"==typeof module&&"object"==typeof module.exports){var n=e(require,exports);void 0!==n&&(module.exports=n)}else"function"==typeof define&&define.amd&&define(["require","exports","../Types","../Collections/LinkedNodeList","../Collections/Queue","../Disposable/ObjectPool","../Environment"],e)}(function(e,n){"use strict";function t(){for(var e;e=m.first;){var n=e.task,t=e.domain,i=e.context,s=e.args;e.canceller(),t&&t.enter(),o(n,t,i,s)}for(;y.tryDequeue(function(e){o(e)}););p=!1}function o(e,n,o,i){try{e.apply(o,i)}catch(s){if(d.isNodeJS)throw n&&n.exit(),setTimeout(t,0),n&&n.enter(),s;setTimeout(function(){throw s},0)}n&&n.exit()}function i(){p||(p=!0,u())}function s(e,n,t){var o=N.take();return o.task=e,o.domain=d.isNodeJS&&process.domain,o.context=n,o.args=t&&t.slice(),o.canceller=function(){if(!o)return!1;var e=Boolean(m.removeNode(o));return N.add(o),e},m.addNode(o),i(),{cancel:o.canceller,dispose:function(){o&&o.canceller()}}}function r(e){y.enqueue(e),i()}Object.defineProperty(n,"__esModule",{value:!0});var u,c=e("../Types"),l=e("../Collections/LinkedNodeList"),a=e("../Collections/Queue"),f=e("../Disposable/ObjectPool"),d=e("../Environment"),p=!1,m=new l.LinkedNodeList,y=new a.Queue,N=new f.ObjectPool(40,function(){return{}},function(e){e.task=null,e.domain=null,e.context=null,e.args&&(e.args.length=0),e.args=null,e.canceller=null});if(n.deferImmediate=s,n.runAfterDeferred=r,d.isNodeJS)u=function(){process.nextTick(t)};else if(typeof setImmediate===c.Type.FUNCTION)u=typeof window!==c.Type.UNDEFINED?setImmediate.bind(window,t):function(){setImmediate(t)};else if(typeof MessageChannel!==c.Type.UNDEFINED){var v=new MessageChannel;v.port1.onmessage=function(){u=g,v.port1.onmessage=t,t()};var g=function(){v.port2.postMessage(0)};u=function(){setTimeout(t,0),g()}}else u=function(){setTimeout(t,0)};n["default"]=s});
//# sourceMappingURL=deferImmediate.js.map